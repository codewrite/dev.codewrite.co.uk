<!DOCTYPE html>
<html lang="en-us">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Camera Object Detection in Python, Part 1 - Codewrite Dev Blog</title>
    <meta name="description" content="C#, Python, VueJS, C&#43;&#43; for Linux, Windows, Raspberry Pi and Arduino. Real Projects from a software engineer who is also an amateur radio enthusiast">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="alternate" type="application/rss+xml" title="Codewrite Dev Blog" href="/index.xml">
</head>
<body>
    <header class="site-header">
    <div class="wrapper header-inner">
        <a class="site-title" href="/">Codewrite Dev Blog</a>
        
        
        <nav class="site-nav" aria-label="Primary navigation">
            <input type="checkbox" id="nav-trigger" class="nav-trigger" />
            <label for="nav-trigger" class="nav-toggle">Menu</label>
            <ul class="nav-list" id="nav-list">
                <li><a href="/">Home</a></li>
                
                
                
                    
                        <li><a href="/about/">About</a></li>
                    
                
                    
                        <li><a href="/general/overview/">Overview</a></li>
                    
                
            </ul>
            <button class="nav-toggle" aria-controls="nav-list" aria-expanded="false">Menu</button>
        </nav>
        
    </div>
</header>

    <main class="page-content">
        <div class="wrapper">
            
<nav class="breadcrumbs" aria-label="Breadcrumbs">
  <div class="breadcrumbs-inner">
    <a href="/">Home</a>
    
      <span class="sep">›</span>
      <a href="/posts/">Posts</a>
    
    <span class="sep">›</span>
    <span class="current">Camera Object Detection in Python, Part 1</span>
  </div>
</nav>


            <div class="content-area">
                <div class="main-column">
                    
<article class="post">
    <header class="post-header">
        <h1 class="post-title">Camera Object Detection in Python, Part 1</h1>
    </header>
    <div class="post-content">
        <p>I have been looking at TensorFlow and following some of the tutorials. I have a camera that looks out over the front garden using a Raspberry Pi 3. It&rsquo;s has quite a low resolution and frame rate (deliberately so that it doesn&rsquo;t use a lot of network bandwidth). The resolution is 640x480 at 3 fps. Usually there is not much going on (which is good) but when something does happen I always thought it would be good to have some automatic processing, and TensorFlow seemed like a great way to do that. I followed one of the [tutorials on a single frame][TensorFlow Object Detection], and it picked out quite a lot of detail, as shown below:</p>
<p><img src="/images/PiCamObjectDetection1/TensorFlowImageClassification.jpg" alt="PiCam Image Classification"></p>
<p>I was quite impressed with what was picked out of the frame, cars in particular seem to be very recognizable (and wheels), but also trees and the house in the background. There were a few trees and plants that weren&rsquo;t categorized and the person wasn&rsquo;t recognized. But other than that, a good effort. The only trouble was that this took about two minutes on my 8 year old i7 laptop. Admittedly I hadn&rsquo;t set it up to use my GPU and I didn&rsquo;t have a TPU, so I guess I shouldn&rsquo;t expect it to be that quick. I think that part of the problem is that object recognition consists of two stages:</p>
<ul>
<li>Object Detection</li>
<li>Classification</li>
</ul>
<p>Simply put, object detection is the process of isolating areas within the image that are candidates for classification. Classification is the process of taking those areas (rectangles) and identifying what the object is. The areas could be overlapping and if the result of the classification is a non-match or low confidence match then the area is discarded.</p>
<p>Object detection on a single frame is much more difficult than on a video stream. That is because on a video stream we can look for areas by detecting movement. For this I used OpenCV in Python3 as shown below:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#007020;font-weight:bold">import</span> <span style="color:#0e84b5;font-weight:bold">numpy</span> <span style="color:#007020;font-weight:bold">as</span> <span style="color:#0e84b5;font-weight:bold">np</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span><span style="color:#007020;font-weight:bold">import</span> <span style="color:#0e84b5;font-weight:bold">cv2</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>stream <span style="color:#666">=</span> cv2<span style="color:#666">.</span>VideoCapture(<span style="color:#4070a0">&#39;http://rpi3b:5000/media/video_feed/&#39;</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>previous_frame <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">None</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span><span style="color:#007020;font-weight:bold">while</span> (stream<span style="color:#666">.</span>isOpened()):
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>    ret, img <span style="color:#666">=</span> stream<span style="color:#666">.</span>read()
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>    <span style="color:#007020;font-weight:bold">if</span> ret:
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>        bw_frame <span style="color:#666">=</span> cv2<span style="color:#666">.</span>cvtColor(img, cv2<span style="color:#666">.</span>COLOR_BGR2GRAY)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>        <span style="color:#007020;font-weight:bold">if</span> (previous_frame <span style="color:#007020;font-weight:bold">is</span> <span style="color:#007020;font-weight:bold">not</span> <span style="color:#007020;font-weight:bold">None</span>):
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>            diff_frame <span style="color:#666">=</span> cv2<span style="color:#666">.</span>absdiff(src1<span style="color:#666">=</span>previous_frame, src2<span style="color:#666">=</span>bw_frame)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>            thresh_frame <span style="color:#666">=</span> cv2<span style="color:#666">.</span>threshold(src<span style="color:#666">=</span>diff_frame, thresh<span style="color:#666">=</span><span style="color:#40a070">20</span>, maxval<span style="color:#666">=</span><span style="color:#40a070">255</span>, <span style="color:#007020">type</span><span style="color:#666">=</span>cv2<span style="color:#666">.</span>THRESH_BINARY)[<span style="color:#40a070">1</span>]
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>            contours, _ <span style="color:#666">=</span> cv2<span style="color:#666">.</span>findContours(image<span style="color:#666">=</span>thresh_frame, mode<span style="color:#666">=</span>cv2<span style="color:#666">.</span>RETR_EXTERNAL, method<span style="color:#666">=</span>cv2<span style="color:#666">.</span>CHAIN_APPROX_SIMPLE)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>            <span style="color:#007020;font-weight:bold">for</span> contour <span style="color:#007020;font-weight:bold">in</span> contours:
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>                <span style="color:#007020;font-weight:bold">if</span> cv2<span style="color:#666">.</span>contourArea(contour) <span style="color:#666">&gt;=</span> <span style="color:#40a070">50</span>:
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>                    (x, y, w, h) <span style="color:#666">=</span> cv2<span style="color:#666">.</span>boundingRect(contour)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>                    cv2<span style="color:#666">.</span>rectangle(img<span style="color:#666">=</span>img, pt1<span style="color:#666">=</span>(x, y), pt2<span style="color:#666">=</span>(x <span style="color:#666">+</span> w, y <span style="color:#666">+</span> h), color<span style="color:#666">=</span>(<span style="color:#40a070">0</span>, <span style="color:#40a070">255</span>, <span style="color:#40a070">0</span>), thickness<span style="color:#666">=</span><span style="color:#40a070">2</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>            cv2<span style="color:#666">.</span>imshow(<span style="color:#4070a0">&#39;B/W Frame Diff&#39;</span>, thresh_frame)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>        previous_frame <span style="color:#666">=</span> bw_frame
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>        cv2<span style="color:#666">.</span>imshow(<span style="color:#4070a0">&#39;B/W Stream&#39;</span>, bw_frame)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>        cv2<span style="color:#666">.</span>imshow(<span style="color:#4070a0">&#39;Motion Detect&#39;</span>, img)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>        cv2<span style="color:#666">.</span>waitKey(<span style="color:#40a070">1</span>)
</span></span></code></pre></div><p>The basic idea is to take the video stream and process each frame to detect changes. This consists of four steps:</p>
<ol>
<li>Convert the image to black and white [Line 9]</li>
<li>Compare the image with the previous image [Line 11]</li>
<li>Create an image with each pixel either 0 for no change, or 1 for change greater than some threshold [Line 12]</li>
<li>Using the pixel change image work out boundaries for changed blocks and superimpose these on the original image [Lines 13-17]</li>
</ol>
<p>I&rsquo;ve created a video that shows the results of steps 1, 3 and 4:</p>
<video width="100%" controls="controls" poster="/images/PiCamObjectDetection1/Rpi3bObjectDetectionWeb-poster.jpg">
  <source src="/images/PiCamObjectDetection1/Rpi3bObjectDetectionWeb.mp4" type="video/mp4" preload="auto">
  Your browser does not support the video tag.
</video>
<p>I think this works pretty well. I use a threshold of 50 pixels (line 15), but I think I could increase that. The downside is that if you increase it too much you could miss changes, but it just depends whether you want to detect cars and people or animals and birds, for example. Also, at about 35 seconds into the video, there is a gust of wind that blows the bush around. This creates a lot of changes that we aren&rsquo;t interested in. Increasing the threshold could help here, but we could also solve this by having a mask that we use on the black and white image (by ANDing it).</p>
<p>I am quite happy with how well this works, and given how little code there is and how fast it runs, I will probably build this into the Raspberry Pi camera code. I could then have an API endpoint that fires events (e.g. by websockets or SSE) when changes are detected. I could then do the TensorFlow processing on a more powerful server - probably my Home Assistant server.</p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://towardsdatascience.com/image-analysis-for-beginners-creating-a-motion-detector-with-opencv-4ca6faba4b42">Detecting Motion with OpenCV</a></li>
<li><a href="https://www.tensorflow.org/hub/tutorials/object_detection">TensorFlow Object Detection</a></li>
</ul>

    </div>
</article>

                </div>
                <aside class="sidebar">
                    <div class="sidebar-inner">
  <section class="widget">
    <h3>Recent posts</h3>
    <ul class="recent-posts">
      
        
          <li><a href="/posts/2023-02-21-picamobjectdetection1/">Camera Object Detection in Python, Part 1</a></li>
        
      
        
          <li><a href="/posts/2022-12-22-hassconfigfiles/">Home Assistant REST Devices and Sensors</a></li>
        
      
        
          <li><a href="/posts/2022-03-28-raspberrypihomeassistant/">Home Assistant on the Raspberry Pi</a></li>
        
      
        
          <li><a href="/posts/2020-08-19-arduinolowpowerencryption/">Arduino Low Power Encryption</a></li>
        
      
        
          <li><a href="/posts/2020-08-14-arduinodefaultlibraries/">Arduino Default Libraries</a></li>
        
      
        
          <li><a href="/posts/2020-08-13-arduinoclassdsound/">Generating sounds on the Arduino</a></li>
        
      
    </ul>
  </section>

  <section class="widget">
    <h3>Categories</h3>
    <ul class="category-list">
      
        <li><a href="/categories/arduino/">arduino</a></li>
      
        <li><a href="/categories/dotnet/">dotnet</a></li>
      
        <li><a href="/categories/encryption/">encryption</a></li>
      
        <li><a href="/categories/jekyll/">jekyll</a></li>
      
        <li><a href="/categories/libraries/">libraries</a></li>
      
        <li><a href="/categories/low/">low</a></li>
      
        <li><a href="/categories/mosfet/">mosfet</a></li>
      
        <li><a href="/categories/nrf24l01/">nrf24l01</a></li>
      
        <li><a href="/categories/power/">power</a></li>
      
        <li><a href="/categories/raspberrypi/">raspberrypi</a></li>
      
        <li><a href="/categories/update/">update</a></li>
      
        <li><a href="/categories/wav/">wav</a></li>
      
    </ul>
  </section>
</div>

                </aside>
            </div>
        </div>
    </main>
    <footer class="site-footer">
        <div class="wrapper">
            <div class="footer-col-wrapper">
                <div class="footer-col footer-col-left">
                    <ul class="footer-links">
                        
                            <li><a href="mailto:jon@codewrite.co.uk">Email</a></li>
                        
                        
                            <li><a href="https://github.com/codewrite" target="_blank">GitHub</a></li>
                        
                        
                            <li><a href="https://twitter.com/codewrite" target="_blank">Twitter</a></li>
                        
                        <li><a href="/index.xml">RSS Feed</a></li>
                    </ul>
                </div>
                <div class="footer-col footer-col-right">
                    <p class="footer-description">C#, Python, VueJS, C&#43;&#43; for Linux, Windows, Raspberry Pi and Arduino. Real Projects from a software engineer who is also an amateur radio enthusiast</p>
                </div>
            </div>
        </div>
    </footer>
</body>
</html>
